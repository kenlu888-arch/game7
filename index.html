<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>數字尋寶</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --btn-main: #3b82f6; 
            --btn-correct: #475569; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body, html { 
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; 
            display: flex; flex-direction: column; font-family: system-ui, sans-serif; 
            background: var(--bg-gradient); 
        }
        header { 
            flex: 0 0 10%; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 5%; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .title { font-size: 3vh; font-weight: 900; }
        #timer { font-size: 5vh; font-weight: bold; color: #ef4444; font-family: monospace; }
        #best-record { font-size: 1.8vh; color: #64748b; }

        #main-area { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            padding: 5px; 
        }
        #game-board { 
            display: grid; gap: 8px; width: 100%; 
            max-width: 95vw; max-height: 95%; 
        }
        .number-btn { 
            aspect-ratio: 1 / 1; border: none; border-radius: 12px; 
            font-size: 5vh; font-weight: bold; color: white; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); display: flex; 
            justify-content: center; align-items: center; touch-action: none;
        }
        .number-btn.correct { 
            background-color: var(--btn-correct) !important; 
            transform: translateY(4px); box-shadow: none; opacity: 0.5; 
        }

        .controls { 
            flex: 0 0 12%; display: flex; justify-content: center; align-items: center; 
            gap: 15px; background: #f1f5f9; padding-bottom: env(safe-area-inset-bottom);
        }
        .control-btn { padding: 1vh 4vh; font-size: 2.5vh; border-radius: 50px; border: none; color: white; font-weight: bold; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        .setting-item { margin-bottom: 15px; text-align: center; }
        .opt-btn { padding: 8px 15px; margin: 2px; border: 1px solid #ccc; border-radius: 8px; background: white; }
        .opt-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body>
    <header>
        <div class="title">數字尋寶</div>
        <div style="text-align:right">
            <div id="timer">0</div>
            <div id="best-record">最佳: --</div>
        </div>
    </header>
    <div id="main-area"><div id="game-board"></div></div>
    <div class="controls">
        <button class="control-btn" style="background:#10b981" onclick="startGame()">開始</button>
        <button class="control-btn" style="background:#64748b" onclick="toggleModal('settings-modal', true)">設定</button>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="setting-item">
                <p>遊戲大小</p>
                <button class="opt-btn" id="sz3" onclick="updateSize(3)">3x3</button>
                <button class="opt-btn" id="sz4" onclick="updateSize(4)">4x4</button>
                <button class="opt-btn" id="sz5" onclick="updateSize(5)">5x5</button>
            </div>
            <div class="setting-item">
                <p>顏色模式</p>
                <button class="opt-btn" id="m1" onclick="updateMode('single')">單一</button>
                <button class="opt-btn" id="m2" onclick="updateMode('mix')">混合</button>
            </div>
            <button class="control-btn" style="background:#ef4444; width:100%; margin-bottom:10px;" onclick="clearRecord()">清除紀錄</button>
            <button class="control-btn" style="background:#3b82f6; width:100%" onclick="toggleModal('settings-modal', false)">完成</button>
        </div>
    </div>

    <script>
        let gridSize = 3, colorMode = 'single', nextNumber = 1, timerInterval = null, startTime = 0, isGameRunning = false;
        const themeColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#f43f5e', '#06b6d4'];
        const board = document.getElementById('game-board');
        let records = JSON.parse(localStorage.getItem('num_game_best')) || {3:null, 4:null, 5:null};

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'zh-TW';
            msg.rate = 1.2;
            window.speechSynthesis.speak(msg);
        }

        function updateBest() {
            const b = records[gridSize];
            document.getElementById('best-record').innerText = b ? `最佳: ${b}` : "最佳: --";
        }

        function updateSize(s) { gridSize = s; resetGame(); }
        function updateMode(m) { colorMode = m; resetGame(); }
        function clearRecord() { if(confirm("確定清除？")) { records[gridSize]=null; localStorage.setItem('num_game_best', JSON.stringify(records)); updateBest(); } }
        function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }

        function resetGame() {
            stopTimer(); nextNumber = 1; isGameRunning = false;
            document.getElementById('timer').innerText = "0";
            board.innerHTML = "";
            board.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            updateBest();
            
            [3,4,5].forEach(i => document.getElementById('sz'+i).className = (gridSize==i?'opt-btn active':'opt-btn'));
            document.getElementById('m1').className = (colorMode=='single'?'opt-btn active':'opt-btn');
            document.getElementById('m2').className = (colorMode=='mix'?'opt-btn active':'opt-btn');

            let nums = Array.from({length: gridSize * gridSize}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            nums.forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.innerText = n;
                btn.style.backgroundColor = (colorMode=='mix') ? themeColors[n % themeColors.length] : '#3b82f6';
                btn.addEventListener('pointerdown', (e) => { e.preventDefault(); handlePress(btn, n); });
                board.appendChild(btn);
            });
        }

        function handlePress(btn, n) {
            if (!isGameRunning || btn.classList.contains('correct')) return;
            if (n === nextNumber) {
                // 這裡已移除 speak(n.toString()) 語音播報
                btn.classList.add('correct');
                nextNumber++;
                if (nextNumber > gridSize * gridSize) endGame();
            }
        }

        function startGame() {
            resetGame();
            isGameRunning = true;
            speak("開始");
            startTime = Date.now();
            timerInterval = setInterval(() => {
                document.getElementById('timer').innerText = Math.floor((Date.now() - startTime) / 10);
            }, 10);
        }

        function stopTimer() { clearInterval(timerInterval); }
        function endGame() { 
            stopTimer(); 
            isGameRunning = false;
            const score = parseInt(document.getElementById('timer').innerText);
            if(!records[gridSize] || score < records[gridSize]) {
                records[gridSize] = score;
                localStorage.setItem('num_game_best', JSON.stringify(records));
                speak("太棒了，破紀錄了");
            } else {
                speak("完成了");
            }
            updateBest();
        }

        resetGame();
    </script>
</body>
</html>