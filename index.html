<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>數字尋寶</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --btn-main: #3b82f6; 
            --btn-correct: #475569; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body, html { 
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; 
            display: flex; flex-direction: column; font-family: system-ui, sans-serif; 
            background: var(--bg-gradient); 
        }
        
        header { 
            flex: 0 0 1６vh; /* 稍微增加高度以容納更大的字體 */
            background: white; 
            border-bottom: 2px solid #e2e8f0;
            padding: calc(10px + env(safe-area-inset-top)) 15px 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
        }

        /* 標題區域極大化 */
        .title-section { flex: 0 0 40%; }
        .title { 
            font-size: 4.8vh; /* 字體進一步放大 */
            font-weight: 900; 
            color: #1e293b; 
            white-space: nowrap; 
            letter-spacing: -1px;
        }

        .btn-section { 
            flex: 1; display: flex; gap: 8px; justify-content: center; padding: 0 5px;
        }
        .control-btn { 
            height: 5vh; width: 70px; font-size: 1.8vh; border-radius: 10px; border: none; 
            color: white; font-weight: bold; box-shadow: 0 3px 0px #1e40af; 
            display: flex; justify-content: center; align-items: center;
        }
        .control-btn:active { transform: translateY(2px); box-shadow: none; }

        .data-section { 
            flex: 0 0 30%; text-align: right; display: flex; flex-direction: column; justify-content: center;
        }
        #timer { font-size: 5vh; font-weight: bold; color: #ef4444; font-family: monospace; line-height: 1; }
        #best-record { font-size: 1.6vh; color: #64748b; font-weight: bold; margin-top: 4px; }

        #main-area { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            padding: 10px; overflow: hidden;
        }
        #game-board { 
            display: grid; gap: 8px;
            width: 95vw; height: 95%; 
            max-width: 75vh; max-height: 95vw; 
            margin: auto;
        }

        .number-btn { 
            aspect-ratio: 1 / 1; border: none; border-radius: 12px; 
            font-weight: 900; color: white; 
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); 
            display: flex; justify-content: center; align-items: center; 
            touch-action: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .number-btn.correct { 
            background-color: var(--btn-correct) !important; 
            transform: translateY(4px); box-shadow: none; opacity: 0.2; 
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        .setting-item { margin-bottom: 20px; text-align: center; }
        .setting-item p { font-size: 2.5vh; font-weight: bold; margin-bottom: 10px; }
        .opt-btn { padding: 10px 20px; font-size: 2.2vh; margin: 4px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; font-weight: bold; color: #475569; }
        .opt-btn.active { background: var(--btn-main); color: white; border-color: var(--btn-main); }
    </style>
</head>
<body>
    <header>
        <div class="title-section">
            <div class="title">數字尋寶</div>
        </div>
        
        <div class="btn-section">
            <button class="control-btn" style="background:#10b981" onclick="startGame()">開始</button>
            <button class="control-btn" style="background:#64748b" onclick="toggleModal('settings-modal', true)">設定</button>
        </div>

        <div class="data-section">
            <div id="timer">0</div>
            <div id="best-record">紀錄: --</div>
        </div>
    </header>

    <div id="main-area">
        <div id="game-board"></div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="setting-item">
                <p>遊戲難度</p>
                <button class="opt-btn" id="sz3" onclick="updateSize(3)">3x3</button>
                <button class="opt-btn" id="sz4" onclick="updateSize(4)">4x4</button>
                <button class="opt-btn" id="sz5" onclick="updateSize(5)">5x5</button>
            </div>
            <div class="setting-item">
                <p>顯示模式</p>
                <button class="opt-btn" id="m-single" onclick="updateMode('single')">單色</button>
                <button class="opt-btn" id="m-multi" onclick="updateMode('multi')">彩色</button>
            </div>
            <button class="control-btn" style="background:#ef4444; width:100%; height:6vh; font-size:2.5vh; margin-bottom:10px; box-shadow:0 3px 0 #991b1b" onclick="clearRecord()">清除紀錄</button>
            <button class="control-btn" style="background:#3b82f6; width:100%; height:6vh; font-size:2.5vh; box-shadow:0 3px 0 #1e40af" onclick="toggleModal('settings-modal', false)">完成</button>
        </div>
    </div>

    <script>
        let gridSize = 3, colorMode = 'single', nextNumber = 1, timerInterval = null, startTime = 0, isGameRunning = false;
        const themeColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4'];
        const board = document.getElementById('game-board');
        let records = JSON.parse(localStorage.getItem('num_game_best')) || {3:null, 4:null, 5:null};

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'zh-TW';
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
        }

        function updateBest() {
            const b = records[gridSize];
            document.getElementById('best-record').innerText = b ? `紀錄: ${b}` : "無紀錄";
        }

        function updateSize(s) { gridSize = s; resetGame(); }
        function updateMode(m) { colorMode = m; resetGame(); }
        function clearRecord() { if(confirm("確定要清除紀錄嗎？")) { records[gridSize]=null; localStorage.setItem('num_game_best', JSON.stringify(records)); updateBest(); } }
        function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }

        function resetGame() {
            stopTimer(); nextNumber = 1; isGameRunning = false;
            document.getElementById('timer').innerText = "0";
            board.innerHTML = "";
            board.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            updateBest();
            
            [3,4,5].forEach(i => document.getElementById('sz'+i).className = (gridSize==i ? 'opt-btn active' : 'opt-btn'));
            document.getElementById('m-single').className = (colorMode=='single' ? 'opt-btn active' : 'opt-btn');
            document.getElementById('m-multi').className = (colorMode=='multi' ? 'opt-btn active' : 'opt-btn');

            let fontSize = (48 / gridSize).toFixed(1) + "vmin";

            let nums = Array.from({length: gridSize * gridSize}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            nums.forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.innerText = n;
                btn.style.fontSize = fontSize; 
                btn.style.backgroundColor = (colorMode=='multi') ? themeColors[n % themeColors.length] : '#3b82f6';
                btn.addEventListener('pointerdown', (e) => { e.preventDefault(); handlePress(btn, n); });
                board.appendChild(btn);
            });
        }

        function handlePress(btn, n) {
            if (!isGameRunning || btn.classList.contains('correct')) return;
            if (n === nextNumber) {
                btn.classList.add('correct');
                nextNumber++;
                if (nextNumber > gridSize * gridSize) endGame();
            }
        }

        function startGame() {
            resetGame();
            isGameRunning = true;
            speak("開始");
            startTime = Date.now();
            timerInterval = setInterval(() => {
                document.getElementById('timer').innerText = Math.floor((Date.now() - startTime) / 10);
            }, 10);
        }

        function stopTimer() { clearInterval(timerInterval); }
        function endGame() { 
            stopTimer(); 
            isGameRunning = false;
            const score = parseInt(document.getElementById('timer').innerText);
            if(!records[gridSize] || score < records[gridSize]) {
                records[gridSize] = score;
                localStorage.setItem('num_game_best', JSON.stringify(records));
                speak("真棒，破紀錄了");
            } else { speak("完成"); }
            updateBest();
        }
        resetGame();
    </script>
</body>
</html>